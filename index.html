<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B√°o C√°o SXKD - ƒê·ªôi QLƒêLKV ƒê·ªãnh H√≥a</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ChartJS & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <!-- Excel processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* 1. C·∫•u h√¨nh Font ch·ªØ Times New Roman cho to√†n b·ªô trang */
    body { 
        font-family: "Times New Roman", Times, serif; 
        background: #f3f4f6; 
        color: #000; 
        font-size: 13pt; /* K√≠ch th∆∞·ªõc chu·∫©n vƒÉn b·∫£n */
    }
    
    .card { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 16px; }
    
    /* Style b·∫£ng b√°o c√°o cho ƒë·∫πp v√† khi in ra */
    .report-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; margin-bottom: 10px; }
    .report-table th { background-color: #e5e7eb; font-weight: bold; text-align: center; padding: 5px; border: 1px solid #000; }
    .report-table td { border: 1px solid #000; padding: 5px; vertical-align: middle; }
    
    /* ƒê·ªãnh d·∫°ng ti√™u ƒë·ªÅ */
    h1, h2, h3, h4 { font-weight: bold; color: #003366; margin-bottom: 0.5em; }
    h1 { font-size: 18pt; text-transform: uppercase; }
    h2 { font-size: 14pt; }
    h3 { font-size: 14pt; border-bottom: 1px solid #000; padding-bottom: 5px; margin-top: 20px;}
    
    .hidden-print { display: block; }

    /* C·∫•u h√¨nh khi in (Xu·∫•t PDF) */
    @media print { 
        .hidden-print { display: none !important; } 
        body { background: white; padding: 0; }
        .card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; }
        /* ƒê·∫£m b·∫£o in m√†u n·ªÅn c·ªßa bi·ªÉu ƒë·ªì/b·∫£ng */
        -webkit-print-color-adjust: exact; 
        print-color-adjust: exact;
        /* Ng·∫Øt trang h·ª£p l√Ω */
        section { break-inside: avoid; }
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <div class="max-w-7xl mx-auto">
    <!-- HEADER: S·∫Ω ƒë∆∞·ª£c ƒë∆∞a v√†o Word -->
    <div class="card flex justify-between items-start bg-white" id="report-header">
      <div style="text-align: left;">
        <h2 style="font-size: 12pt; font-weight: bold; margin: 0;">C√îNG TY ƒêI·ªÜN L·ª∞C TH√ÅI NGUY√äN</h2>
        <h1 style="font-size: 14pt; font-weight: bold; color: #003366; margin: 5px 0;">ƒê·ªòI QLƒêLKV ƒê·ªäNH H√ìA</h1>
      </div>
      <div style="text-align: right;">
        <div style="font-size: 16pt; font-weight: 900; color: #003366;">B√ÅO C√ÅO S·∫¢N XU·∫§T KINH DOANH</div>
        <div style="font-size: 14pt; font-weight: bold; color: #cc0000; margin-top: 5px;" id="display-period">Th√°ng -- NƒÉm ----</div>
      </div>
    </div>

    <!-- CONTROLS AREA -->
    <div class="card hidden-print space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- File Uploads -->
        <div class="space-y-2">
          <p class="font-bold text-sm text-gray-700">1. N·∫°p d·ªØ li·ªáu ƒë·∫ßu v√†o:</p>
          <div class="flex flex-wrap gap-2">
            <input type="file" id="f-bc" accept=".xlsx,.xls" hidden />
            <button onclick="document.getElementById('f-bc').click()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm transition font-bold">
              üìÇ 1. Upload Baocao_tonghop
            </button>

            <input type="file" id="f-bckd" accept=".xlsx,.xls" hidden />
            <button onclick="document.getElementById('f-bckd').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm transition font-bold">
              üìÇ 2. Upload BCKD_Thang
            </button>
            
            <input type="file" id="f-ecp" accept=".xlsx,.xls" hidden />
            <button onclick="document.getElementById('f-ecp').click()" class="bg-teal-600 hover:bg-teal-700 text-white px-3 py-2 rounded text-sm transition font-bold">
              üìÇ 3. Upload ECP
            </button>
          </div>
          <div id="file-status" class="text-xs text-gray-500 italic mt-1">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn.</div>
        </div>

        <!-- Month/Year Selection -->
        <div class="space-y-2 border-l pl-4 border-gray-200">
          <p class="font-bold text-sm text-gray-700">2. Ch·ªçn k·ª≥ b√°o c√°o (Quan tr·ªçng):</p>
          <div class="flex items-center gap-3">
            <div class="flex items-center gap-1">
              <span class="text-sm">Th√°ng:</span>
              <select id="sel-month" class="border rounded p-1.5 bg-gray-50 font-bold text-blue-800"></select>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-sm">NƒÉm:</span>
              <select id="sel-year" class="border rounded p-1.5 bg-gray-50 font-bold text-blue-800"></select>
            </div>
            <button id="btn-apply-period" class="bg-red-600 hover:bg-red-700 text-white px-4 py-1.5 rounded text-sm font-bold shadow-sm">
              √ÅP D·ª§NG
            </button>
          </div>
          <p class="text-xs text-gray-500">Ch·ªçn th·ªùi gian ƒë·ªÉ l·ªçc d·ªØ li·ªáu KPI v√† S·ª± c·ªë t·ª´ file t·ªïng h·ª£p.</p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-wrap gap-2 border-t pt-4 mt-2">
        <button id="btn-manual" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 text-sm">Nh·∫≠p tay s·ªë li·ªáu d√¢y</button>
        <div class="flex-grow"></div>
        <button id="btn-gen" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-bold shadow text-sm">
          T·∫†O B√ÅO C√ÅO
        </button>
        <button id="btn-export-word" class="bg-blue-800 hover:bg-blue-900 text-white px-4 py-2 rounded text-sm font-bold">
          Xu·∫•t file Word
        </button>
        <!-- Thay th·∫ø n√∫t Powerpoint b·∫±ng n√∫t Xu·∫•t PDF/·∫¢nh (Presentation) -->
        <button id="btn-export-ppt" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm font-bold" title="S·ª≠ d·ª•ng ch·ª©c nƒÉng In c·ªßa tr√¨nh duy·ªát ƒë·ªÉ t·∫°o PDF ho·∫∑c ·∫£nh ch·∫•t l∆∞·ª£ng cao ƒë·ªÉ tr√¨nh b√†y">
          Xu·∫•t PDF/·∫¢nh (Presentation)
        </button>
        <button id="btn-export-pdf" class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded text-sm font-bold" title="K√≠ch ho·∫°t h·ªôp tho·∫°i In/L∆∞u PDF c·ªßa tr√¨nh duy·ªát">
          In / L∆∞u PDF
        </button>
      </div>
    </div>

    <!-- MANUAL INPUT SECTION -->
    <div id="manual-area" class="card hidden hidden-print">
      <h3 class="font-bold text-gray-700 mb-2">Nh·∫≠p tay chi·ªÅu d√†i/ti·∫øt di·ªán d√¢y (ƒê∆°n v·ªã: km):</h3>
      <!-- B·ªï sung th√™m ƒê∆∞·ªùng d√¢y h·∫° th·∫ø -->
      <!-- T·ªïng chi·ªÅu d√†i s·∫Ω ƒë∆∞·ª£c t√≠nh to√°n l·∫°i trong JS (Ch·ªâ t√≠nh trung th·∫ø) -->
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <input id="m-total" placeholder="T·ªïng chi·ªÅu d√†i TT (km)" class="border p-2 rounded text-sm" value="">
        <input id="m-471" placeholder="471 E6.22 (km)" class="border p-2 rounded text-sm" value="20.5">
        <input id="m-472" placeholder="472 E6.22 (km)" class="border p-2 rounded text-sm" value="15.0">
        <input id="m-473" placeholder="473 E6.22 (km)" class="border p-2 rounded text-sm" value="18.2">
        <input id="m-371" placeholder="371 E6.22 (km)" class="border p-2 rounded text-sm" value="12.8">
        <input id="m-373" placeholder="373 E6.22 (km)" class="border p-2 rounded text-sm" value="10.5">
        <input id="m-lt" placeholder="ƒê∆∞·ªùng d√¢y h·∫° th·∫ø (km)" class="border p-2 rounded text-sm" value="150.0">
      </div>
      <textarea id="m-other" class="w-full border p-2 rounded mt-3 text-sm" placeholder="Nh·∫≠p n·ªôi dung m·ª•c 6 (C√¥ng t√°c kh√°c)..."></textarea>
    </div>

    <!-- REPORT CONTENT AREA -->
    <div id="report-content" class="min-h-screen hidden bg-white p-4">
      
      <!-- 1. QU·∫¢N TR·ªä -->
      <section class="mb-8">
        <h3>1. C√îNG T√ÅC QU·∫¢N TR·ªä</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="h-64 border p-2"><canvas id="c-age"></canvas></div>
          <div class="h-64 border p-2"><canvas id="c-dept"></canvas></div>
          <div class="h-64 border p-2"><canvas id="c-qual"></canvas></div>
        </div>
      </section>

      <!-- 2. KINH DOANH -->
      <section class="mb-8">
        <h3>2. C√îNG T√ÅC KINH DOANH & DVKH</h3>
        <div id="bckd-table-area" class="overflow-x-auto mb-4"></div>
      </section>

      <!-- 3. K·ª∏ THU·∫¨T -->
      <section class="mb-8">
        <h3>3. C√îNG T√ÅC QU·∫¢N L√ù K·ª∏ THU·∫¨T</h3>
        
        <!-- 3.1 TBA -->
        <div class="mb-6">
          <h4 class="font-bold text-black mb-2">3.1. S·ªë li·ªáu Tr·∫°m bi·∫øn √°p (T·ªïng h·ª£p theo ƒë∆∞·ªùng d√¢y)</h4>
          <div id="tba-summary-area" class="overflow-x-auto"></div>
        </div>

        <!-- 3.2 D√¢y -->
        <div class="mb-6">
          <h4 class="font-bold text-black mb-2">3.2. T·ªïng chi·ªÅu d√†i ƒë∆∞·ªùng d√¢y trung th·∫ø</h4>
          <div id="wire-summary" class="bg-gray-50 p-3 border text-sm"></div>
        </div>

        <!-- 3.3 S·ª± c·ªë -->
        <div>
          <h4 class="font-bold text-black mb-2">3.3. T√¨nh h√¨nh s·ª± c·ªë</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="h-64 border p-2"><canvas id="c-inc-type"></canvas></div>
            <div class="h-64 border p-2"><canvas id="c-inc-nature"></canvas></div>
          </div>
          <div id="incident-list-area"></div>
        </div>
      </section>

      <!-- 4. AN TO√ÄN -->
      <section class="mb-8">
        <h3>4. C√îNG T√ÅC AN TO√ÄN (ECP)</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="h-64 border p-2"><canvas id="c-ecp1"></canvas></div>
          <div class="h-64 border p-2"><canvas id="c-ecp2"></canvas></div>
        </div>
      </section>

      <!-- 5. KPI -->
      <section class="mb-8">
        <h3>5. CH·ªà TI√äU KPI</h3>
        <div class="grid grid-cols-1 gap-6">
            <div>
                <h4 class="font-bold text-sm text-center mb-2">Bi·ªÉu ƒë·ªì 5.1: KPI c√°c ƒë∆°n v·ªã th√°ng b√°o c√°o</h4>
                <div class="h-80 border p-2"><canvas id="c-kpi-all"></canvas></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-bold text-sm text-center mb-2">Bi·ªÉu ƒë·ªì 5.2: L≈©y k·∫ø KPI ƒê·ªãnh H√≥a</h4>
                    <div class="h-64 border p-2"><canvas id="c-kpi-cumulative"></canvas></div>
                </div>
                <div>
                    <h4 class="font-bold text-sm text-center mb-2">Bi·ªÉu ƒë·ªì 5.3: So s√°nh c√πng k·ª≥</h4>
                    <div class="h-64 border p-2"><canvas id="c-kpi-yoy"></canvas></div>
                </div>
            </div>
        </div>
        <div id="kpi-debug" class="text-xs text-red-400 mt-2"></div>
      </section>

      <!-- 6. KH√ÅC -->
      <section class="mb-8">
        <h3>6. C√ÅC C√îNG T√ÅC KH√ÅC</h3>
        <div id="other-content" class="text-sm whitespace-pre-line text-gray-700"></div>
      </section>

      <div class="text-right text-sm italic mt-8 pb-8">
        ƒê·ªãnh H√≥a, ng√†y <span id="print-date"></span><br>
        <strong>Ng∆∞·ªùi l·∫≠p bi·ªÉu</strong>
      </div>
    </div>
  </div>

<script>
// --- C·∫§U H√åNH CHART JS ---
Chart.register(ChartDataLabels);
Chart.defaults.font.family = "'Times New Roman', serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#000';
Chart.defaults.maintainAspectRatio = false;
Chart.defaults.set('plugins.datalabels', {
  display: true,
  color: '#000',
  anchor: 'end',
  align: 'top',
  offset: 2,
  font: { weight: 'bold', size: 10 },
  formatter: (value) => {
    if (value === 0) return '';
    if (value > 1000) return (value / 1000).toFixed(1) + 'k';
    return parseFloat(value).toFixed(2).replace(/\.00$/, '').toLocaleString('vi-VN');
  } 
});

// GLOBAL STATE
const state = {
  files: { baocao: null, bckd: null, ecp: null },
  month: new Date().getMonth() + 1,
  year: new Date().getFullYear(),
  charts: []
};

// Colors for charts with multiple categories (Y√™u c·∫ßu 4 & 5)
const CHART_COLORS = [
    '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#6366f1', '#ec4899', '#8b5cf6',
    '#06b6d4', '#f97316', '#14b8a6', '#a855f7', '#fb923c', '#d946ef', '#0ea5e9',
    '#e11d48', '#059669', '#ca8a04', '#7c3aed', '#be185d', '#4f46e5', '#22c3e5'
];

// --- KH·ªûI T·∫†O (Y√™u c·∫ßu 1: Th√™m nƒÉm ƒë·∫øn 2030) ---
(function init() {
  const selMonth = document.getElementById('sel-month');
  for(let i=1; i<=12; i++) selMonth.add(new Option(i, i));
  selMonth.value = state.month;

  const selYear = document.getElementById('sel-year');
  const curY = new Date().getFullYear();
  // ƒêi·ªÅu ch·ªânh d·∫£i nƒÉm t·ª´ (Hi·ªán t·∫°i - 3) ƒë·∫øn 2030
  const maxYear = 2030;
  for(let i=curY-3; i<=maxYear; i++) selYear.add(new Option(i, i));
  selYear.value = state.year;

  document.getElementById('display-period').innerText = `Th√°ng ${state.month} NƒÉm ${state.year}`;
  document.getElementById('print-date').innerText = new Date().toLocaleDateString('vi-VN');
})();

// --- S·ª∞ KI·ªÜN DOM ---
document.getElementById('btn-apply-period').onclick = () => {
  state.month = parseInt(document.getElementById('sel-month').value);
  state.year = parseInt(document.getElementById('sel-year').value);
  document.getElementById('display-period').innerText = `Th√°ng ${state.month} NƒÉm ${state.year}`;
  const statusEl = document.getElementById('file-status');
  statusEl.innerHTML = `<span class="text-blue-600 font-bold">ƒê√£ ch·ªçn: T${state.month}/${state.year}. Nh·∫•n "T·∫†O B√ÅO C√ÅO".</span>`;
};

document.getElementById('btn-manual').onclick = () => {
  document.getElementById('manual-area').classList.toggle('hidden');
};

// C·∫≠p nh·∫≠t l·∫°i logic: n√∫t PPT c≈© gi·ªù th√†nh n√∫t Xu·∫•t PDF/·∫¢nh (Presentation)
document.getElementById('btn-export-ppt').onclick = () => {
    const reportNode = document.getElementById('report-content');
    if (reportNode.classList.contains('hidden')) {
        const genButton = document.getElementById('btn-gen');
        genButton.textContent = 'Vui l√≤ng T·∫†O B√ÅO C√ÅO tr∆∞·ªõc!';
        genButton.classList.add('animate-pulse');
        setTimeout(() => {
            genButton.textContent = 'T·∫†O B√ÅO C√ÅO';
            genButton.classList.remove('animate-pulse');
        }, 3000);
        return;
    }
    // K√≠ch ho·∫°t h·ªôp tho·∫°i In (Print) c·ªßa tr√¨nh duy·ªát. Ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªçn 'Save as PDF'
    window.print();
};


const handleFile = (e, key) => {
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type: 'array', cellDates: false});
    const json = {};
    workbook.SheetNames.forEach(name => {
      json[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name], {header: 1, defval: ''});
    });
    state.files[key] = json;
    updateFileStatus();
  };
  reader.readAsArrayBuffer(f);
};

document.getElementById('f-bc').onchange = (e) => handleFile(e, 'baocao');
document.getElementById('f-bckd').onchange = (e) => handleFile(e, 'bckd');
document.getElementById('f-ecp').onchange = (e) => handleFile(e, 'ecp');

function updateFileStatus() {
  const s = state.files;
  const list = [];
  if(s.baocao) list.push('Baocao_tonghop');
  if(s.bckd) list.push('BCKD_Thang');
  if(s.ecp) list.push('ECP');
  document.getElementById('file-status').innerText = list.length ? "ƒê√£ n·∫°p: " + list.join(', ') : "Ch∆∞a c√≥ file n√†o.";
}

// --- MAIN GENERATE FUNCTION ---
document.getElementById('btn-gen').onclick = () => {
  state.charts.forEach(c => c.destroy());
  state.charts = [];
  
  document.getElementById('report-content').classList.remove('hidden');

  renderSection1_HR();
  renderSection2_Business();
  renderSection3_Tech();
  renderSection4_Safety();
  renderSection5_KPI();
  renderSection6_Other();

  document.getElementById('report-content').scrollIntoView({behavior:'smooth'});
};

// Y√™u c·∫ßu 4: Cho m·ªói c·ªôt m·ªôt m√†u ri√™ng cho bi·ªÉu ƒë·ªì B·ªô ph·∫≠n v√† Tr√¨nh ƒë·ªô
function renderSection1_HR() {
  const data = state.files.baocao ? (state.files.baocao['CBCNV'] || Object.values(state.files.baocao)[0]) : [];
  if(data.length < 2) return; 
  const rows = data.slice(1);
  const ageStats = {'<30':0, '30-40':0, '40-50':0, '>50':0};
  const qualStats = {};
  const deptStats = {};
  const header = data[0].map(x => String(x).toLowerCase());
  const idxAge = header.findIndex(h => h.includes('ƒë·ªô tu·ªïi')) !== -1 ? header.findIndex(h => h.includes('ƒë·ªô tu·ªïi')) : 16;
  const idxQual = header.findIndex(h => h.includes('tr√¨nh ƒë·ªô') || h.includes('chuy√™n m√¥n')) !== -1 ? header.findIndex(h => h.includes('tr√¨nh ƒë·ªô')) : 8;
  const idxDept = header.findIndex(h => h.includes('b·ªô ph·∫≠n') || h.includes('ƒë∆°n v·ªã')) !== -1 ? header.findIndex(h => h.includes('b·ªô ph·∫≠n')) : 13;

  rows.forEach(r => {
    if(!r[0]) return;
    const age = parseInt(r[idxAge]) || 0;
    if(age > 0) {
      if(age < 30) ageStats['<30']++;
      else if(age <= 40) ageStats['30-40']++;
      else if(age <= 50) ageStats['40-50']++;
      else ageStats['>50']++;
    }
    const q = String(r[idxQual] || 'Kh√°c').trim();
    qualStats[q] = (qualStats[q] || 0) + 1;
    const d = String(r[idxDept] || 'Kh√°c').trim();
    deptStats[d] = (deptStats[d] || 0) + 1;
  });
  // S·ª≠ d·ª•ng createChart v·ªõi m√†u s·∫Øc ri√™ng cho t·ª´ng c·ªôt
  createChart('c-age', 'doughnut', ageStats, 'ƒê·ªô tu·ªïi', true); 
  createChart('c-qual', 'bar', qualStats, 'Tr√¨nh ƒë·ªô', true); // True ƒë·ªÉ d√πng m√†u ri√™ng
  createChart('c-dept', 'bar', deptStats, 'B·ªô ph·∫≠n', true); // True ƒë·ªÉ d√πng m√†u ri√™ng
}

function renderSection2_Business() {
  const container = document.getElementById('bckd-table-area');
  container.innerHTML = '';
  if(!state.files.bckd) return;
  const sheet = Object.values(state.files.bckd)[0];
  if(!sheet || sheet.length < 2) return;
  const header = ['STT', 'Ch·ªâ ti√™u', 'ƒêVT', 'K·∫ø ho·∫°ch', 'Th·ª±c hi·ªán'];
  let html = '<table class="report-table"><thead><tr>';
  header.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  const rawData = sheet.slice(1);
  let sttCounter = 1;
  rawData.forEach((row, index) => {
    if (index === 19 || index === 20) return; 
    if (sttCounter > 25) return;
    const chiTieu = row[1] || '';
    if(!chiTieu) return;
    const dvt = row[2] || '';
    const kh = parseFloat(row[3]) || 0;
    const th = parseFloat(row[4]) || 0;
    html += `<tr><td class="text-center">${sttCounter++}</td><td>${chiTieu}</td><td class="text-center">${dvt}</td><td class="text-right">${kh.toLocaleString('vi-VN')}</td><td class="text-right font-bold">${th.toLocaleString('vi-VN')}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// 3. K·ª∏ THU·∫¨T - FIX L·ªñI HI·ªÇN TH·ªä C·ªòT 'SL' C·ª¶A T√ÄI S·∫¢N KH√ÅCH H√ÄNG
function renderSection3_Tech() {
  // 3.1 TBA (Y√™u c·∫ßu 3: Th√™m d√≤ng t·ªïng c·ªông)
  const tbaArea = document.getElementById('tba-summary-area');
  tbaArea.innerHTML = '';
  // Ch·ªâ l·∫•y 5 ƒë∆∞·ªùng d√¢y trung th·∫ø
  const targetLines = ['471E6.22', '472E6.22', '473E6.22', '371E6.22', '373E6.22']; 
  const tbaDataSheet = state.files.baocao ? (state.files.baocao['T√™n c√°c TBA'] || state.files.baocao['TBA']) : null;
  
  let totalCount = 0;
  let totalKVA = 0;
  let totalDl = 0;
  let totalKh = 0;

  if(tbaDataSheet) {
    const data = tbaDataSheet;
    const idxLine = 2; const idxCap = 5; const idxOwner = 7;
    const agg = {};
    data.slice(1).forEach(r => {
      // Logic ƒë∆°n gi·∫£n: n·∫øu ƒë∆∞·ªùng d√¢y kh√¥ng kh·ªõp, b·ªè qua
      const lineName = String(r[idxLine] || '').trim();
      if (!targetLines.includes(lineName)) return; 
      
      const capStr = String(r[idxCap] || '0').toUpperCase().replace('KVA', '').trim();
      const cap = parseFloat(capStr) || 0;
      const owner = String(r[idxOwner] || '').toLowerCase();
      
      if(!agg[lineName]) agg[lineName] = { count: 0, kva: 0, kh: 0, dl: 0 };
      
      agg[lineName].count++; agg[lineName].kva += cap;
      if(owner.includes('kh√°ch h√†ng') || owner.includes('kh')) { agg[lineName].kh++; totalKh++; } else { agg[lineName].dl++; totalDl++; }
      
      totalCount++; 
      totalKVA += cap;
    });

    let html = `<table class="report-table"><thead><tr><th rowspan="2">ƒê∆∞·ªùng d√¢y</th><th colspan="2">T·ªïng c·ªông</th><th colspan="2">T√†i s·∫£n ƒêi·ªán l·ª±c</th><th colspan="2">T√†i s·∫£n Kh√°ch h√†ng</th></tr><tr><th>SL</th><th>kVA</th><th>SL</th><th>%</th><th>SL</th><th>%</th></tr></thead><tbody>`;
    Object.keys(agg).sort().forEach(line => {
      const d = agg[line];
      const pDl = d.count>0?((d.dl/d.count)*100).toFixed(0):0;
      const pKh = d.count>0?((d.kh/d.count)*100).toFixed(0):0;
      html += `<tr>
                  <td class="font-bold">${line}</td>
                  <td class="text-center font-bold">${d.count}</td>
                  <td class="text-right">${d.kva.toLocaleString('vi-VN')}</td>
                  <td class="text-center">${d.dl}</td>
                  <td class="text-center">${pDl}%</td>
                  <td class="text-center">${d.kh}</td> <!-- ƒê√£ S·ª¨A: d.kh l√† s·ªë l∆∞·ª£ng Kh√°ch h√†ng -->
                  <td class="text-center">${pKh}%</td>
              </tr>`;
    });
    
    // D√≤ng T·ªîNG C·ªòNG
    const totalPdl = totalCount > 0 ? ((totalDl/totalCount)*100).toFixed(0) : 0;
    const totalPkh = totalCount > 0 ? ((totalKh/totalCount)*100).toFixed(0) : 0;
    html += `<tr>
                <td class="font-bold bg-gray-200">T·ªîNG C·ªòNG</td>
                <td class="text-center font-bold bg-gray-200">${totalCount}</td>
                <td class="text-right font-bold bg-gray-200">${totalKVA.toLocaleString('vi-VN')}</td>
                <td class="text-center font-bold bg-gray-200">${totalDl}</td>
                <td class="text-center font-bold bg-gray-200">${totalPdl}%</td>
                <td class="text-center font-bold bg-gray-200">${totalKh}</td> <!-- ƒê√£ S·ª¨A: totalKh l√† t·ªïng s·ªë l∆∞·ª£ng Kh√°ch h√†ng -->
                <td class="text-center font-bold bg-gray-200">${totalPkh}%</td>
            </tr>`;
    
    html += '</tbody></table>';
    tbaArea.innerHTML = html;
  }

  // 3.2 D√¢y (Ch·ªâ t√≠nh t·ªïng c·ªông ƒë∆∞·ªùng d√¢y trung th·∫ø)
  let totalLengthTT = 0;
  // Ch·ªâ l·∫•y 5 ƒë∆∞·ªùng d√¢y trung th·∫ø ƒë·ªÉ t√≠nh t·ªïng
  const wireInputsTT = ['m-471','m-472','m-473','m-371','m-373']; 
  wireInputsTT.forEach(id=>{ totalLengthTT += parseFloat(document.getElementById(id).value)||0; });
  // C·∫≠p nh·∫≠t gi√° tr·ªã v√†o √¥ nh·∫≠p li·ªáu
  document.getElementById('m-total').value = totalLengthTT.toFixed(1);
  
  document.getElementById('wire-summary').innerHTML = `<ul class="grid grid-cols-2 gap-2">
    <li class="font-bold text-blue-800">T·ªïng chi·ªÅu d√†i ƒë∆∞·ªùng d√¢y trung th·∫ø: ${totalLengthTT.toFixed(1)} km</li>
    <li>471 E6.22: ${document.getElementById('m-471').value} km</li>
    <li>472 E6.22: ${document.getElementById('m-472').value} km</li>
    <li>473 E6.22: ${document.getElementById('m-473').value} km</li>
    <li>371 E6.22: ${document.getElementById('m-371').value} km</li>
    <li>373 E6.22: ${document.getElementById('m-373').value} km</li>
    <li class="font-bold text-red-700">ƒê∆∞·ªùng d√¢y h·∫° th·∫ø: ${document.getElementById('m-lt').value} km</li>
    </ul>`;

  // 3.3 S·ª± c·ªë (Gi·ªØ nguy√™n)
  const incArea = document.getElementById('incident-list-area');
  incArea.innerHTML = '';
  const incData = state.files.baocao ? (state.files.baocao['Qu·∫£n l√Ω s·ª± c·ªë'] || state.files.baocao['S·ª± c·ªë']) : null;
  
  if(incData) {
    // Ch·ªâ s·ªë c·ªôt trong Excel (A=0, B=1...)
    const idxLocation = 2; // C·ªôt C: V·ªã tr√≠
    const idxReason = 3;   // C·ªôt D: T√≥m t·∫Øt nguy√™n nh√¢n
    const idxType = 4;     // C·ªôt E: Lo·∫°i
    const idxDate = 5;     // C·ªôt F: Th·ªùi gian
    const idxNature = 8;   // C·ªôt I: T√≠nh ch·∫•t
    const idxLine = 9;     // C·ªôt J: ƒê∆∞·ªùng d√¢y
    const idxMonthYear = 10; // C·ªôt K: Th√°ng/NƒÉm (D√πng ƒë·ªÉ l·ªçc)

    const filteredInc = incData.slice(1).filter(r => {
      let d = null;
      const kValue = r[idxMonthYear];
      
      // X·ª≠ l√Ω ng√†y th√°ng c·ªôt K
      if (kValue) {
          if (typeof kValue === 'string') {
              if (kValue.includes('-')) {
                  const parts = kValue.split('-'); // YYYY-MM-DD
                  if (parts.length === 3) d = new Date(parts[0], parts[1] - 1, parts[2]);
              } else if (kValue.includes('/')) {
                  const parts = kValue.split('/'); // DD/MM/YYYY
                  d = new Date(parts[2], parts[1] - 1, parts[0]);
              }
          } else if (typeof kValue === 'number') {
              d = new Date((kValue - (25567 + 2)) * 86400 * 1000);
          }
      }
      // Fallback c·ªôt F n·∫øu K l·ªói
      if (!d && r[idxDate]) {
          const fValue = r[idxDate];
           if (typeof fValue === 'string') {
               const datePart = fValue.substring(0, 10); 
               if(datePart.includes('/')) {
                   const parts = datePart.split('/');
                   d = new Date(parts[2], parts[1]-1, parts[0]);
               }
           }
      }

      if(d && !isNaN(d.getTime())) {
        return d.getMonth() + 1 === state.month && d.getFullYear() === state.year;
      }
      return false;
    });

    const typeStats = {}; const natureStats = {};
    // Header b·∫£ng: th√™m STT, V·ªã tr√≠ (C), Nguy√™n nh√¢n (D)
    let html = '<table class="report-table mt-2"><thead><tr><th>STT</th><th>Ng√†y</th><th>ƒê∆∞·ªùng d√¢y</th><th>V·ªã tr√≠/Thi·∫øt b·ªã</th><th>T√≥m t·∫Øt Nguy√™n nh√¢n</th><th>T√≠nh ch·∫•t</th><th>Lo·∫°i s·ª± c·ªë</th></tr></thead><tbody>';
    
    if(filteredInc.length === 0) {
      html += '<tr><td colspan="7" class="text-center italic">Kh√¥ng c√≥ s·ª± c·ªë trong th√°ng.</td></tr>';
    }

    filteredInc.forEach((r, idx) => {
        // Format Ng√†y (dd/mm/yyyy)
        let rawDate = r[idxMonthYear] || r[idxDate];
        let dateStr = '---';
        
        let dObj = null;
        if(typeof rawDate === 'number') {
             dObj = new Date((rawDate - (25567 + 2)) * 86400 * 1000);
        } else if (typeof rawDate === 'string') {
             if(rawDate.includes('-')) {
                 const p = rawDate.split('-'); dObj = new Date(p[0], p[1]-1, p[2]);
             } else if(rawDate.includes('/')) {
                 // Gi·∫£ s·ª≠ input d·∫°ng dd/mm/yyyy ho·∫∑c mm/dd/yyyy t√πy Excel, nh∆∞ng ∆∞u ti√™n split
                 const p = rawDate.split(' ')[0].split('/'); // B·ªè ph·∫ßn gi·ªù n·∫øu c√≥
                 if(p.length === 3) dObj = new Date(p[2], p[1]-1, p[0]);
             }
        }
        
        if(dObj && !isNaN(dObj.getTime())) {
            dateStr = `${String(dObj.getDate()).padStart(2,'0')}/${String(dObj.getMonth()+1).padStart(2,'0')}/${dObj.getFullYear()}`;
        } else {
            // Fallback hi·ªÉn th·ªã chu·ªói g·ªëc n·∫øu ko parse ƒë∆∞·ª£c
            dateStr = String(rawDate).substring(0, 10);
        }

        const location = r[idxLocation] || '';
        const reason = r[idxReason] || '';
        const nature = r[idxNature] || '';
        const line = r[idxLine] || '';
        const type = r[idxType] || '';

        html += `<tr>
            <td class="text-center">${idx + 1}</td>
            <td>${dateStr}</td>
            <td>${line}</td>
            <td>${location}</td>
            <td>${reason}</td>
            <td>${nature}</td>
            <td>${type}</td>
        </tr>`;

        // Chart Data
        const t = String(type).trim(); typeStats[t] = (typeStats[t] || 0) + 1;
        const n = String(nature).trim(); natureStats[n] = (natureStats[n] || 0) + 1;
    });
    html += '</tbody></table>';
    incArea.innerHTML = html;
    createChart('c-inc-type', 'pie', typeStats, 'Ph√¢n lo·∫°i', true);
    createChart('c-inc-nature', 'bar', natureStats, 'T√≠nh ch·∫•t', true);
  } else {
    incArea.innerHTML = '<p class="text-red-500">Thi·∫øu sheet "Qu·∫£n l√Ω s·ª± c·ªë".</p>';
  }
}

function renderSection4_Safety() {
  if(!state.files.ecp) return;
  const sheet = Object.values(state.files.ecp)[0];
  const stats = {}; const types = {};
  sheet.slice(1).forEach(r => {
    const status = String(r[r.length - 1] || 'Kh√°c').trim();
    stats[status] = (stats[status] || 0) + 1;
    const type = String(r[r.length - 2] || 'Kh√°c').trim();
    types[type] = (types[type] || 0) + 1;
  });
  createChart('c-ecp1', 'doughnut', stats, 'Tr·∫°ng th√°i Phi·∫øu', true);
  createChart('c-ecp2', 'bar', types, 'Lo·∫°i c√¥ng t√°c', true);
}

// Y√™u c·∫ßu 5: Bi·ªÉu ƒë·ªì KPI s·∫Øp x·∫øp gi·∫£m d·∫ßn v√† m·ªói ƒë∆°n v·ªã m·ªôt m√†u ri√™ng
function renderSection5_KPI() {
  ['c-kpi-all', 'c-kpi-cumulative', 'c-kpi-yoy'].forEach(id => {
    const c = document.getElementById(id); 
    if(c) { const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
  });
  
  if(!state.files.baocao) return;
  const kpiSheetName = Object.keys(state.files.baocao).find(k => k.toUpperCase() === 'KPI');
  if(!kpiSheetName) return;
  const data = state.files.baocao[kpiSheetName];
  if(data.length<2) return;

  const idxYear = 0; const idxMonth = 1; const idxName = 2; const idxVal = 3;

  // --- CHART 1: KPI T·∫§T C·∫¢ ƒê∆†N V·ªä (S·∫Øp x·∫øp v√† m√†u s·∫Øc ri√™ng) ---
  const targetUnits = [
      "ƒê·ªãnh H√≥a", "ƒê·ªìng H·ª∑", "ƒê·∫°i T·ª´", "Ph√∫ B√¨nh", "Ph√∫ L∆∞∆°ng", "Ph·ªï Y√™n", "S√¥ng C√¥ng", "Th√°i Nguy√™n", "V√µ Nhai",
      "B·∫Øc K·∫°n", "Ng√¢n S∆°n", "Ba B·ªÉ", "P√°c N·∫∑m", "Ch·ª£ ƒê·ªìn", "Na R√¨", "Ch·ª£ M·ªõi"
  ];

  const currentMonthData = data.slice(1).filter(r => {
    return parseInt(r[idxMonth]) === state.month && parseInt(r[idxYear]) === state.year;
  });

  const kpiDataMap = {};
  targetUnits.forEach(unitName => {
      const row = currentMonthData.find(r => String(r[idxName]).includes(unitName));
      const val = row ? parseFloat(row[idxVal]) : 0;
      kpiDataMap[unitName] = val;
  });
  
  // S·∫Øp x·∫øp gi·∫£m d·∫ßn theo gi√° tr·ªã KPI
  const sortedUnits = Object.entries(kpiDataMap).sort(([,a], [,b]) => b - a);
  const labels1 = sortedUnits.map(([unit]) => unit);
  const values1 = sortedUnits.map(([,value]) => value);
  
  // T·∫°o m·∫£ng m√†u s·∫Øc ri√™ng bi·ªát, highlight ƒê·ªãnh H√≥a
  const colors1 = labels1.map((unit, index) => {
      if (unit === 'ƒê·ªãnh H√≥a') return '#dc2626'; // M√†u ƒë·ªè n·ªïi b·∫≠t cho ƒê·ªãnh H√≥a
      // D√πng m·∫£ng m√†u ƒë√£ ƒë·ªãnh nghƒ©a
      return CHART_COLORS[index % CHART_COLORS.length];
  });

  const ctxAll = document.getElementById('c-kpi-all').getContext('2d');
  state.charts.push(new Chart(ctxAll, {
    type: 'bar',
    data: {
      labels: labels1,
      datasets: [{
        label: `KPI T${state.month}/${state.year}`,
        data: values1,
        backgroundColor: colors1, // D√πng m·∫£ng m√†u ri√™ng bi·ªát
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'x', 
      plugins: {
        legend: { display: false },
        datalabels: { 
            color: '#000', 
            anchor: 'end', 
            align: 'top', 
            rotation: -90,
            offset: 0
        }
      },
      scales: { 
          y: { 
              beginAtZero: false, 
              min: 80 // ƒê·∫£m b·∫£o bi·ªÉu ƒë·ªì c√≥ √Ω nghƒ©a
          },
          x: {
              // ƒê·∫£m b·∫£o label kh√¥ng b·ªã c·∫Øt
              ticks: { autoSkip: false, maxRotation: 90, minRotation: 90 }
          }
      }
    }
  }));

  // --- CHART 2 & 3 gi·ªØ nguy√™n logic ---
  const dhKpi = data.slice(1).filter(r => {
    return parseInt(r[idxYear]) === state.year && String(r[idxName]).includes('ƒê·ªãnh H√≥a') && parseInt(r[idxMonth]) <= state.month;
  }).sort((a,b) => parseInt(a[idxMonth]) - parseInt(b[idxMonth]));

  if(dhKpi.length > 0) {
      const cumu = []; let sum = 0;
      for(let i=0; i<dhKpi.length; i++) {
          sum += parseFloat(dhKpi[i][idxVal]) || 0;
          cumu.push(sum / (i+1));
      }
      const ctx2 = document.getElementById('c-kpi-cumulative').getContext('2d');
      state.charts.push(new Chart(ctx2, {
          type: 'line',
          data: {
              labels: dhKpi.map(r => `T${r[idxMonth]}`),
              datasets: [{
                  label: 'L≈©y k·∫ø TB',
                  data: cumu,
                  borderColor: '#10b981',
                  backgroundColor: '#10b981',
                  tension: 0.1
              }]
          },
          options: { scales: { y: { min: 90 } } }
      }));
  }

  const curVal = kpiDataMap['ƒê·ªãnh H√≥a'] || 0;
  const lastYear = state.year - 1;
  const lastYearRow = data.slice(1).find(r => parseInt(r[idxMonth])===state.month && parseInt(r[idxYear])===lastYear && String(r[idxName]).includes('ƒê·ªãnh H√≥a'));
  const lastVal = lastYearRow ? parseFloat(lastYearRow[idxVal]) : 0;

  const ctx3 = document.getElementById('c-kpi-yoy').getContext('2d');
  state.charts.push(new Chart(ctx3, {
      type: 'bar',
      data: {
          labels: [`${state.month}/${lastYear}`, `${state.month}/${state.year}`],
          datasets: [{
              label: 'ƒêi·ªÉm KPI',
              data: [lastVal, curVal],
              backgroundColor: ['#9ca3af', '#dc2626']
          }]
      },
      options: { scales: { y: { min: 80 } }, plugins: { legend: {display: false} } }
  }));
}

function renderSection6_Other() {
  document.getElementById('other-content').innerText = document.getElementById('m-other').value || "(Ch∆∞a c√≥ n·ªôi dung)";
}

// Th√™m tham s·ªë useMultipleColors (Y√™u c·∫ßu 4)
function createChart(id, type, dataObj, title, useMultipleColors = false) {
  const ctx = document.getElementById(id);
  if(!ctx) return;
  
  let colors;
  if(useMultipleColors) {
    // D√πng m·∫£ng m√†u ƒëa d·∫°ng cho t·ª´ng c·ªôt/ph·∫ßn
    colors = Object.keys(dataObj).map((_, index) => CHART_COLORS[index % CHART_COLORS.length]);
  } else {
    // D√πng m√†u ƒë∆°n s·∫Øc cho Bar, ho·∫∑c m·∫£ng m√†u cho Doughnut n·∫øu kh√¥ng y√™u c·∫ßu ƒë·∫∑c bi·ªát
    colors = type==='bar' ? CHART_COLORS[0] : CHART_COLORS;
  }
  
  state.charts.push(new Chart(ctx, {
    type: type,
    data: {
      labels: Object.keys(dataObj),
      datasets: [{ 
          label: title, 
          data: Object.values(dataObj), 
          backgroundColor: colors // S·ª≠ d·ª•ng m·∫£ng m√†u ƒë√£ ch·ªçn
      }]
    },
    options: { 
        plugins: { 
            legend: { 
                display: type!=='bar' // Hi·ªÉn th·ªã legend cho Pie/Doughnut
            }, 
            title: { 
                display: true, 
                text: title 
            } 
        } 
    }
  }));
}

// --- XU·∫§T FILE WORD: GI·ªÆ NGUY√äN LOGIC C≈® ---
document.getElementById('btn-export-word').onclick = () => {
    const reportNode = document.getElementById('report-content');
    const headerNode = document.getElementById('report-header'); 

    if (reportNode.classList.contains('hidden')) {
        const genButton = document.getElementById('btn-gen');
        genButton.textContent = 'Vui l√≤ng T·∫†O B√ÅO C√ÅO tr∆∞·ªõc!';
        genButton.classList.add('animate-pulse');
        setTimeout(() => {
            genButton.textContent = 'T·∫†O B√ÅO C√ÅO';
            genButton.classList.remove('animate-pulse');
        }, 3000);
        return;
    }

    const cloneContent = reportNode.cloneNode(true);
    const cloneHeader = headerNode.cloneNode(true); 

    // Convert Canvas to Images in Clone
    const canvases = reportNode.querySelectorAll('canvas');
    const clonedCanvases = cloneContent.querySelectorAll('canvas');

    canvases.forEach((canvas, index) => {
        const imgData = canvas.toDataURL("image/png");
        const img = document.createElement('img');
        img.src = imgData;
        img.style.width = '100%';
        img.style.maxWidth = '600px'; 
        clonedCanvases[index].parentNode.replaceChild(img, clonedCanvases[index]);
    });

    // T·∫°o HTML cho Word, gh√©p Header v√†o tr∆∞·ªõc Content
    const header = `<html xmlns:o='urn:schemas-microsoft-com:office:office' 
                          xmlns:w='urn:schemas-microsoft-com:office:word' 
                          xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>B√°o c√°o SXKD</title>
        <style>
            body { font-family: 'Times New Roman', serif; font-size: 13pt; }
            table { border-collapse: collapse; width: 100%; margin-bottom: 10px; }
            td, th { border: 1px solid black; padding: 5px; }
            h1 { font-size: 16pt; text-align: center; color: #003366; text-transform: uppercase; }
            h2 { font-size: 14pt; }
            h3 { font-size: 14pt; color: #003366; margin-top: 15px; border-bottom: 1px solid #000; }
            .text-center { text-align: center; }
            .text-right { text-align: right; }
        </style>
        </head><body>`;
    
    // Gh√©p Header + N·ªôi dung
    const sourceHTML = header + cloneHeader.innerHTML + "<br><hr><br>" + cloneContent.innerHTML + "</body></html>";

    const blob = new Blob(['\ufeff', sourceHTML], {
        type: 'application/msword'
    });
    
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `BaoCao_SXKD_T${state.month}_${state.year}.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// XU·∫§T PDF: D√πng window.print() chu·∫©n h∆°n
document.getElementById('btn-export-pdf').onclick = () => {
    window.print();
};
</script>
</body>
</html>